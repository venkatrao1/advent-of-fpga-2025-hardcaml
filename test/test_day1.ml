open! Core
open! Hardcaml
open! Hardcaml_waveterm
open! Hardcaml_test_harness
module Day1 = Hardcaml_demo_project.Day1

let sample_input = "\
  L68\n\
  L30\n\
  R48\n\
  L5\n\
  R60\n\
  L55\n\
  L1\n\
  L99\n\
  R14\n\
  L82\n\
"

module Harness = Cyclesim_harness.Make (Day1.I) (Day1.O)

let ( <--. ) = Bits.( <--. )

let simple_testbench (sim : Harness.Sim.t) =
  let inputs = Cyclesim.inputs sim in
  let outputs = Cyclesim.outputs sim in
  let cycle ?n () = Cyclesim.cycle ?n sim in
  (* Helper function for inputting one value *)
  let feed_input n =
    inputs.char_in.value <--. Char.to_int n;
    inputs.char_in.valid := Bits.vdd;
    cycle ();
    inputs.char_in.valid := Bits.gnd;
    cycle ()
  in
  (* Reset the design *)
  inputs.char_in.valid <--. 0;
  inputs.char_in.value <--. 0;
  inputs.clear := Bits.vdd;
  cycle ();
  inputs.clear := Bits.gnd;
  cycle ();
  (* Input sample file *)
  String.iter sample_input ~f:(fun x -> feed_input x);
  feed_input (Char.of_int_exn 0); (* null terminator *)

  (* Wait for result to become valid *)
  while not (Bits.to_bool !(outputs.answer.valid)) do
    cycle ()
  done;
  let answer = Bits.to_unsigned_int !(outputs.answer.value) in
  print_s [%message "Result" (answer : int)];
  (* Show in the waveform that [valid] stays high. *)
  cycle ~n:2 ()
;;

(* The [waves_config] argument to [Harness.run] determines where and how to save waveforms
   for viewing later with a waveform viewer. The commented examples below show how to save
   a waveterm file or a VCD file. *)
let waves_config = Waves_config.no_waves

(* let waves_config = *)
(*   Waves_config.to_directory "/tmp/" *)
(* |> Waves_config.as_wavefile_format ~format:Hardcamlwaveform *)
(* ;; *)

(* let waves_config = *)
(*   Waves_config.to_directory "/tmp/" *)
(* |> Waves_config.as_wavefile_format ~format:Vcd *)
(* ;; *)

let%expect_test "Simple test, optionally saving waveforms to disk" =
  Harness.run_advanced ~waves_config ~create:Day1.Part1.hierarchical simple_testbench;
  [%expect {| (Result (answer 3)) |}]
;;


let%expect_test "Simple test with printing waveforms directly" =
  (* For simple tests, we can print the waveforms directly in an expect-test (and use the
     command [dune promote] to update it after the tests run). This is useful for quickly
     visualizing or documenting a simple circuit, but limits the amount of data that can
     be shown. *)
  let display_rules =
    [ Display_rule.port_name_matches
        ~wave_format:(Bit_or Unsigned_int)
        (Glob "day1*")
    ]
  in
  Harness.run_advanced
    ~create:Day1.Part1.hierarchical
    ~trace:`All_named
    ~print_waves_after_test:(fun waves ->
      Waveform.print
        ~display_rules
          (* [display_rules] is optional, if not specified, it will print all named
             signals in the design. *)
        ~signals_width:30
        ~display_width:200
        ~wave_width:1
        (* [wave_width] configures how many chars wide each clock cycle is *)
        waves)
    simple_testbench;
  [%expect
    {|
    (Result (answer 3))
    ┌Signals─────────────────────┐┌Waves───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │                            ││────────────────────────────────────────────────────────────────────────────────────────────────────┬───────────────────────────────────────────────────────────────────│
    │day1_part1$answer           ││ 0                                                                                                  │1                                                                  │
    │                            ││────────────────────────────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────│
    │day1_part1$answer_valid     ││                                                                                                                                                                        │
    │                            ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                            ││────────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────│
    │day1_part1$digit_parser$i$ch││ 0      │76     │54     │56     │10     │76     │51     │48     │10     │82     │52     │56     │10     │76     │53     │10     │82     │54     │48     │10     │76     │
    │                            ││────────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────│
    │day1_part1$digit_parser$o$di││                ┌───────────────┐               ┌───────────────┐               ┌───────────────┐               ┌───────┐               ┌───────────────┐               │
    │                            ││────────────────┘               └───────────────┘               └───────────────┘               └───────────────┘       └───────────────┘               └───────────────│
    │                            ││────────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────│
    │day1_part1$digit_parser$o$di││ 0      │12     │6      │8      │10     │12     │3      │0      │10     │2      │4      │8      │10     │12     │5      │10     │2      │6      │0      │10     │12     │
    │                            ││────────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────│
    │day1_part1$facing_right     ││                                                                            ┌───────────────────────────────┐                       ┌───────────────────────────────┐   │
    │                            ││────────────────────────────────────────────────────────────────────────────┘                               └───────────────────────┘                               └───│
    │day1_part1$facing_right_next││                                                                        ┌───┐   ┌───┐   ┌───┐   ┌───┐                           ┌───┐   ┌───┐   ┌───┐   ┌───┐           │
    │                            ││────────────────────────────────────────────────────────────────────────┘   └───┘   └───┘   └───┘   └───────────────────────────┘   └───┘   └───┘   └───┘   └───────────│
    │day1_part1$i$char_in$valid  ││        ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   │
    │                            ││────────┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───│
    │                            ││────────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────│
    │day1_part1$i$char_in$value  ││ 0      │76     │54     │56     │10     │76     │51     │48     │10     │82     │52     │56     │10     │76     │53     │10     │82     │54     │48     │10     │76     │
    │                            ││────────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────│
    │day1_part1$i$clear          ││────┐                                                                                                                                                                   │
    │                            ││    └───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │day1_part1$i$clock          ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                            ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │day1_part1$o$answer$valid   ││                                                                                                                                                                        │
    │                            ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                            ││────────────────────────────────────────────────────────────────────────────────────────────────────┬───────────────────────────────────────────────────────────────────│
    │day1_part1$o$answer$value   ││ 0                                                                                                  │1                                                                  │
    │                            ││────────────────────────────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────│
    │                            ││────────────────────┬───────┬───────┬───────────────┬───────┬───────────────────────┬───────┬───────┬───────────────┬───────┬───────────────┬───────┬───────────────────│
    │day1_part1$ones_place       ││ 0                  │6      │8      │0              │3      │0                      │4      │8      │0              │5      │0              │6      │0                  │
    │                            ││────────────────────┴───────┴───────┴───────────────┴───────┴───────────────────────┴───────┴───────┴───────────────┴───────┴───────────────┴───────┴───────────────────│
    │                            ││────┬───────────────────────────────┬───────────────────────────────┬───────┬───────────────────────┬───────────────────────┬───────┬───────────────────────┬───────┬───│
    │day1_part1$pos              ││ 0  │50                             │18                             │48     │52                     │0                      │5      │95                     │55     │45 │
    │                            ││────┴───────────────────────────────┴───────────────────────────────┴───────┴───────────────────────┴───────────────────────┴───────┴───────────────────────┴───────┴───│
    │                            ││────┬───────────────┬───────┬───────────────────────┬───────┬───────────────┬───────┬───────┬───────────────────────┬───────────────┬───────┬───────┬───────────────┬───│
    │day1_part1$pos_next         ││ 0  │50             │56     │18                     │21     │48             │52     │56     │0                      │5              │95     │1      │55             │45 │
    │                            ││────┴───────────────┴───────┴───────────────────────┴───────┴───────────────┴───────┴───────┴───────────────────────┴───────────────┴───────┴───────┴───────────────┴───│
    │                            ││────────────────────────────┬───────┬───────────────────────┬───────┬───────────────────────┬───────┬───────────────────────────────────────────────┬───────┬───────────│
    │day1_part1$tens_place       ││ 0                          │6      │0                      │3      │0                      │4      │0                                              │6      │0          │
    │                            ││────────────────────────────┴───────┴───────────────────────┴───────┴───────────────────────┴───────┴───────────────────────────────────────────────┴───────┴───────────│
    └────────────────────────────┘└────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]
;;
